name: testapp-cicd
run-name: ${{ github.actor }} triggered pipeline with ${{ github.sha }} activity.

on: 
  push:
    branches: 
      - 'release/dev'
  pull_request:
    branches:
      - 'release/dev'
jobs:
  testapp-deployment:
     runs-on: ubuntu-22.04
     environment: dev
     steps:
     - name: 'Checkout GitHub Action' 
       uses: actions/checkout@v3
     - name: 'Get Azure Container Registry secrets from keyvault'
       uses: Azure/get-keyvault-secrets@v1
       with:
         keyvault: kv-appimplementation-dev
         secrets: 'containerregistrypassword, containerregistryusername'
       id: acrSecret
     - name: 'Login to Azure Container Registry'
       uses: azure/docker-login@v1
       with:
         login-server: ${{ secrets.ACR_SERVER }}
         username: ${{ steps.acrSecret.outputs.containerregistryusername }}
         password: ${{ steps.acrSecret.outputs.containerregistrypassword }}
     - name: 'Image build and push to ACR'
       run: |
         docker build . -t ${{ secrets.ACR_SERVER }}/testapp:${{ github.sha }}
         docker push ${{ secrets.ACR_SERVER }}/testapp:${{ github.sha }}

     - name: 'Az CLI login'
       uses: azure/login@v1
       with:
          creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'

     - name: 'Deploying image to App Service'
       uses: azure/webapps-deploy@v2
       with:
        app-name: 'testapprwdev'
        images: ${{ secrets.ACR_SERVER }}/testapp:${{ github.sha }}
         





   
 
     